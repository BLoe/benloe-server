# Infrastructure

This directory contains everything needed to rebuild the benloe.com VPS from scratch.

## Directory Structure

```
infra/
├── caddy/                    # Caddy configs for each subdomain
│   ├── auth.caddyfile
│   ├── dada.benloe.com
│   ├── fitness.benloe.com
│   ├── gamenight.benloe.com
│   ├── weights.benloe.com
│   └── ...
├── system/                   # System-level configs (copied to /etc/)
│   ├── Caddyfile            # Main Caddyfile → /etc/caddy/Caddyfile
│   └── sshd/
│       └── 99-hardening.conf # SSH hardening → /etc/ssh/sshd_config.d/
├── scripts/
│   ├── bootstrap.sh         # Full server setup from scratch
│   └── backup-databases.sh  # SQLite database backup
└── README.md                # This file
```

## Rebuilding the Server

If you need to set up a new VPS from scratch:

```bash
# 1. Provision Ubuntu 22.04+ VPS (DigitalOcean, etc.)

# 2. SSH in as root and clone the repo
git clone git@github.com:BLoe/benloe-server.git /srv/benloe

# 3. Run bootstrap script
/srv/benloe/infra/scripts/bootstrap.sh

# 4. Set up secrets
cp /srv/benloe/.env.example /srv/benloe/.env
nano /srv/benloe/.env  # Fill in your secrets

# 5. Start applications
cd /srv/benloe && pm2 start apps/*/ecosystem.config.js

# 6. Restore database backups (if you have them)
cp /path/to/backups/*.db /srv/benloe/data/
```

## Database Backups

SQLite databases in `/srv/benloe/data/` are the only irreplaceable data. Back them up!

### Manual Backup
```bash
/srv/benloe/infra/scripts/backup-databases.sh
```

### Automatic Backup (cron)
```bash
# Add to root's crontab: crontab -e
0 3 * * * /srv/benloe/infra/scripts/backup-databases.sh
```

### Offsite Backup
For true disaster recovery, sync backups offsite:
```bash
# Example: rsync to another server
rsync -avz /srv/benloe/backups/ user@backup-server:/backups/benloe/

# Example: upload to S3
aws s3 sync /srv/benloe/backups/ s3://your-bucket/benloe-backups/
```

## Firewall Rules

The bootstrap script configures UFW with:

| Port | Protocol | Purpose |
|------|----------|---------|
| 22 | TCP | SSH |
| 80 | TCP | HTTP (Caddy) |
| 443 | TCP | HTTPS (Caddy) |
| 60000-61000 | UDP | Mosh |

## What's NOT in Git

These must be recreated manually or restored from backups:

- `/srv/benloe/.env` - Secrets (use `.env.example` as template)
- `/srv/benloe/data/*.db` - SQLite databases
- SSL certificates - Auto-regenerated by Caddy
- SSH keys - Must be added to new server
