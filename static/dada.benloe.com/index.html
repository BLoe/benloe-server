<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defense Against the Dart Arts - DADA</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üéØ</text></svg>">
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        .darts-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .hogwarts-banner {
            background: linear-gradient(90deg, #740001 0%, #ae0001 50%, #740001 100%);
            color: #d3a625;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .dart-button {
            min-width: 60px;
            transition: all 0.2s;
        }

        .dart-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .dart-button.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Auth screens -->
    <div id="authCheck" class="flex items-center justify-center min-h-screen darts-gradient">
        <div class="text-center text-white">
            <div class="text-5xl mb-4">üéØ</div>
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
            <p class="text-xl">Checking authentication...</p>
        </div>
    </div>

    <div id="notAuthenticated" class="flex items-center justify-center min-h-screen darts-gradient hidden">
        <div class="text-center bg-white p-10 rounded-lg shadow-2xl max-w-md">
            <div class="text-5xl mb-4">üéØ</div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Defense Against the Dart Arts</h1>
            <p class="text-sm text-purple-600 mb-4 italic">"Constant Vigilance in Practice!"</p>
            <p class="text-gray-600 mb-6">Please sign in to begin your darts training journey.</p>
            <a href="https://auth.benloe.com/?redirect=https://dada.benloe.com"
               class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-md hover:from-purple-700 hover:to-indigo-700 font-medium inline-block w-full">
                Sign In to Continue
            </a>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Homepage - Trainer Mode -->
        <div id="homepage">
            <div class="hogwarts-banner py-4 px-4 shadow-lg">
                <div class="container mx-auto flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span class="text-3xl">üéØ</span>
                        <div>
                            <h1 class="text-xl md:text-2xl font-bold">Defense Against the Dart Arts</h1>
                            <p class="text-xs text-yellow-300 italic hidden md:block">"Constant Vigilance!"</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 md:gap-4">
                        <button onclick="app.copyDebugInfo()" class="text-yellow-200 hover:text-yellow-100 text-xs md:text-sm border border-yellow-400 px-2 py-1 rounded">
                            Debug
                        </button>
                        <span id="userGreetingHome" class="text-yellow-200 text-sm md:text-base"></span>
                    </div>
                </div>
            </div>

            <div class="container mx-auto px-4 py-6 max-w-2xl">
                <!-- Professor's Recommendation -->
                <div class="bg-gray-800 text-gray-100 rounded-lg p-6 mb-6">
                    <div class="flex items-start gap-3">
                        <div class="text-4xl">üßô‚Äç‚ôÇÔ∏è</div>
                        <div class="flex-1">
                            <p class="text-lg font-semibold mb-2">Professor Moody</p>
                            <p id="recommendationText" class="text-gray-300 mb-4 italic">
                                Loading your training plan...
                            </p>
                            <div id="recommendedDrill" class="bg-gray-700 rounded-lg p-4 mb-3">
                                <div class="text-xl font-bold text-purple-400 mb-1" id="recommendedDrillName">...</div>
                                <div class="text-sm text-gray-400" id="recommendedDrillDesc">...</div>
                            </div>
                            <button onclick="app.startRecommendedDrill()"
                                    class="w-full bg-purple-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-purple-700 mb-2">
                                Begin Training
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Alternative Drills -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Alternative Drills</h3>
                    <div id="alternativeDrills" class="space-y-2">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-2 gap-4">
                    <button class="bg-white rounded-lg shadow p-4 text-center hover:shadow-lg transition-shadow"
                            onclick="alert('Coming soon!')">
                        <div class="text-2xl mb-2">üìä</div>
                        <div class="font-semibold text-gray-800">View Progress</div>
                    </button>
                    <button class="bg-white rounded-lg shadow p-4 text-center hover:shadow-lg transition-shadow"
                            onclick="alert('Coming soon!')">
                        <div class="text-2xl mb-2">üìú</div>
                        <div class="font-semibold text-gray-800">Drill History</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Drill Practice View -->
        <div id="drillPractice" class="hidden">
        <div class="hogwarts-banner py-4 px-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <button onclick="app.confirmBackToHome()" class="text-yellow-200 hover:text-yellow-100 mr-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <span class="text-3xl">üéØ</span>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold">Defense Against the Dart Arts</h1>
                        <p class="text-xs text-yellow-300 italic hidden md:block">"Constant Vigilance!"</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <span id="userGreeting" class="text-yellow-200 text-sm md:text-base"></span>
                </div>
            </div>
        </div>

        <div class="container mx-auto px-4 py-6 max-w-2xl">
            <!-- Professor's Instruction -->
            <div class="bg-gray-800 text-gray-100 rounded-lg p-4 mb-4">
                <div class="flex items-start gap-3">
                    <div class="text-3xl">üßô‚Äç‚ôÇÔ∏è</div>
                    <div class="flex-1">
                        <p class="text-sm font-semibold mb-1">Professor Moody</p>
                        <p id="professorComment" class="text-sm text-gray-300 italic">
                            "Your drill today: focus on Treble 20. Show me you can hit it with consistency. Begin."
                        </p>
                    </div>
                </div>
            </div>

            <!-- Current Drill -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
                <div class="text-center mb-4">
                    <div class="text-sm text-gray-500 mb-1">Current Drill</div>
                    <div id="drillName" class="text-2xl font-bold text-purple-600">Treble 20 Focus</div>
                    <div id="drillDescription" class="text-sm text-gray-600 mt-2">
                        Throw at Treble 20. Track your accuracy.
                    </div>
                </div>

                <!-- Drill Progress -->
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-semibold text-gray-700">Progress</span>
                        <span id="drillProgress" class="text-sm text-gray-600">0 / 10 throws</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="bg-purple-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Simple Dart Input -->
                <div class="border-t pt-4">
                    <div class="text-sm font-semibold text-gray-700 mb-3">Enter Your Throw</div>

                    <!-- Number Selection -->
                    <div class="mb-4">
                        <label class="text-xs text-gray-500 block mb-2">Number</label>
                        <div class="grid grid-cols-5 gap-2 mb-2">
                            <button onclick="app.selectNumber(20)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">20</button>
                            <button onclick="app.selectNumber(19)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">19</button>
                            <button onclick="app.selectNumber(18)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">18</button>
                            <button onclick="app.selectNumber(17)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">17</button>
                            <button onclick="app.selectNumber(16)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">16</button>
                        </div>
                        <div class="grid grid-cols-5 gap-2 mb-2">
                            <button onclick="app.selectNumber(15)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">15</button>
                            <button onclick="app.selectNumber(14)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">14</button>
                            <button onclick="app.selectNumber(13)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">13</button>
                            <button onclick="app.selectNumber(12)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">12</button>
                            <button onclick="app.selectNumber(11)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">11</button>
                        </div>
                        <div class="grid grid-cols-5 gap-2 mb-2">
                            <button onclick="app.selectNumber(10)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">10</button>
                            <button onclick="app.selectNumber(9)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">9</button>
                            <button onclick="app.selectNumber(8)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">8</button>
                            <button onclick="app.selectNumber(7)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">7</button>
                            <button onclick="app.selectNumber(6)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">6</button>
                        </div>
                        <div class="grid grid-cols-5 gap-2 mb-2">
                            <button onclick="app.selectNumber(5)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">5</button>
                            <button onclick="app.selectNumber(4)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">4</button>
                            <button onclick="app.selectNumber(3)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">3</button>
                            <button onclick="app.selectNumber(2)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">2</button>
                            <button onclick="app.selectNumber(1)" class="dart-button bg-white border-2 border-gray-300 rounded px-3 py-2 font-semibold">1</button>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="app.selectNumber('bull')" class="dart-button bg-green-600 text-white border-2 border-green-600 rounded px-3 py-2 font-semibold">Bull (25)</button>
                            <button onclick="app.selectNumber(0)" class="dart-button bg-gray-400 text-white border-2 border-gray-400 rounded px-3 py-2 font-semibold">Miss (0)</button>
                        </div>
                    </div>

                    <!-- Ring Type Selection -->
                    <div class="mb-4" id="ringTypeSection" style="display: none;">
                        <label class="text-xs text-gray-500 block mb-2">Ring Type</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="app.selectRingType('single')" class="dart-button bg-white border-2 border-gray-300 rounded px-4 py-3 font-semibold">Single</button>
                            <button onclick="app.selectRingType('double')" class="dart-button bg-red-600 text-white border-2 border-red-600 rounded px-4 py-3 font-semibold">Double</button>
                            <button onclick="app.selectRingType('treble')" class="dart-button bg-green-600 text-white border-2 border-green-600 rounded px-4 py-3 font-semibold">Treble</button>
                        </div>
                    </div>

                    <!-- Selected Throw Display -->
                    <div id="selectedThrow" class="bg-purple-50 border-2 border-purple-200 rounded-lg p-3 text-center mb-3" style="display: none;">
                        <div class="text-sm text-gray-600 mb-1">Selected</div>
                        <div class="text-xl font-bold text-purple-600" id="selectedThrowText">-</div>
                        <div class="text-2xl font-bold text-purple-800" id="selectedThrowScore">-</div>
                    </div>

                    <button onclick="app.recordThrow()" id="recordButton"
                            class="w-full bg-purple-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                            disabled>
                        Record Throw
                    </button>
                </div>
            </div>

            <!-- Session Stats -->
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="bg-white rounded-lg shadow p-4 text-center">
                    <div class="text-2xl font-bold text-blue-600" id="sessionThrows">0</div>
                    <div class="text-xs text-gray-500">Throws</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 text-center">
                    <div class="text-2xl font-bold text-green-600" id="sessionAccuracy">0%</div>
                    <div class="text-xs text-gray-500">Accuracy</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 text-center">
                    <div class="text-2xl font-bold text-purple-600" id="session3DA">0.0</div>
                    <div class="text-xs text-gray-500">3DA</div>
                </div>
            </div>

            <!-- Recent Throws -->
            <div class="bg-white rounded-lg shadow p-4">
                <h3 class="text-sm font-semibold text-gray-800 mb-3">Recent Throws</h3>
                <div id="recentThrows" class="space-y-2">
                    <p class="text-gray-500 text-xs text-center py-4">No throws yet</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        class DADAApp {
            constructor() {
                this.API_BASE_URL = 'https://dada.benloe.com/api';
                this.user = null;
                this.currentDrill = null;
                this.currentSession = null;
                this.drillProgress = [];
                this.sessionThrows = [];
                this.selectedNumber = null;
                this.selectedRingType = null;
                this.availableDrills = [];
                this.debugLog = [];

                this.init();
            }

            log(message, data = null) {
                const entry = {
                    timestamp: new Date().toISOString(),
                    message,
                    data
                };
                this.debugLog.push(entry);
                console.log(`[DADA] ${message}`, data);
            }

            async init() {
                try {
                    this.log('Init started');
                    await this.checkAuth();
                    if (this.user) {
                        this.log('User authenticated', { user: this.user });
                        await this.loadDrills();
                        this.showMainApp();
                        await this.loadRecommendation();
                        this.showHomepage();
                    } else {
                        this.log('User not authenticated');
                        this.showNotAuthenticated();
                    }
                } catch (error) {
                    this.log('Init error', { error: error.message, stack: error.stack });
                    console.error('Init error:', error);
                }
            }

            async loadDrills() {
                try {
                    this.log('Loading drills from API', { url: `${this.API_BASE_URL}/drills` });
                    const response = await fetch(`${this.API_BASE_URL}/drills`, {
                        credentials: 'include'
                    });
                    this.log('Drills API response', { status: response.status, ok: response.ok });
                    if (response.ok) {
                        this.availableDrills = await response.json();
                        this.log('Drills loaded', { count: this.availableDrills.length, drills: this.availableDrills });
                    } else {
                        this.log('Failed to load drills - bad response', { status: response.status });
                    }
                } catch (error) {
                    this.log('Failed to load drills - exception', { error: error.message, stack: error.stack });
                    console.error('Failed to load drills:', error);
                }
            }

            async loadRecommendation() {
                try {
                    this.log('Loading recommendation from API', { url: `${this.API_BASE_URL}/drills/recommended` });
                    const response = await fetch(`${this.API_BASE_URL}/drills/recommended`, {
                        credentials: 'include'
                    });
                    this.log('Recommendation API response', { status: response.status, ok: response.ok });
                    if (response.ok) {
                        this.recommendation = await response.json();
                        this.log('Recommendation loaded', this.recommendation);
                        this.updateRecommendationUI();
                    } else {
                        const errorText = await response.text();
                        this.log('Failed to load recommendation - bad response', { status: response.status, error: errorText });
                        document.getElementById('recommendationText').textContent =
                            '"Your first session awaits. Choose a drill to begin."';
                    }
                } catch (error) {
                    this.log('Failed to load recommendation - exception', { error: error.message, stack: error.stack });
                    console.error('Failed to load recommendation:', error);
                    document.getElementById('recommendationText').textContent =
                        '"Your first session awaits. Choose a drill to begin."';
                }
            }

            updateRecommendationUI() {
                if (!this.recommendation) return;

                const { drill, reason, alternatives } = this.recommendation;

                document.getElementById('recommendationText').textContent =
                    `"Your drill today: ${drill.name}. ${reason}"`;
                document.getElementById('recommendedDrillName').textContent = drill.name;
                document.getElementById('recommendedDrillDesc').textContent = drill.description;

                // Populate alternatives
                const altContainer = document.getElementById('alternativeDrills');
                altContainer.innerHTML = alternatives.map(alt => `
                    <button onclick="app.startDrill('${alt.id}')"
                            class="w-full text-left p-3 rounded bg-gray-50 hover:bg-gray-100 transition-colors">
                        <div class="font-semibold text-gray-800">${alt.name}</div>
                        <div class="text-xs text-gray-500">${alt.category}</div>
                    </button>
                `).join('');
            }

            showHomepage() {
                document.getElementById('homepage').classList.remove('hidden');
                document.getElementById('drillPractice').classList.add('hidden');
                if (this.user) {
                    const greeting = this.user.name || this.user.email || 'Practitioner';
                    document.getElementById('userGreetingHome').textContent = greeting;
                }
            }

            showDrillPractice() {
                document.getElementById('homepage').classList.add('hidden');
                document.getElementById('drillPractice').classList.remove('hidden');
            }

            async startRecommendedDrill() {
                if (this.recommendation && this.recommendation.drill) {
                    await this.startDrill(this.recommendation.drill.id);
                }
            }

            confirmBackToHome() {
                if (this.drillProgress.length > 0) {
                    if (confirm('Are you sure? Your current session will be abandoned.')) {
                        this.showHomepage();
                    }
                } else {
                    this.showHomepage();
                }
            }

            async copyDebugInfo() {
                try {
                    // Collect all debug information
                    const debugInfo = {
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        url: window.location.href,
                        appState: {
                            apiBaseUrl: this.API_BASE_URL,
                            user: this.user,
                            currentDrill: this.currentDrill,
                            currentSession: this.currentSession,
                            availableDrillsCount: this.availableDrills.length,
                            recommendation: this.recommendation,
                            drillProgressCount: this.drillProgress.length
                        },
                        debugLog: this.debugLog,
                        consoleErrors: window.consoleErrors || [],
                        uiState: {
                            recommendationText: document.getElementById('recommendationText')?.textContent,
                            recommendedDrillName: document.getElementById('recommendedDrillName')?.textContent,
                            recommendedDrillDesc: document.getElementById('recommendedDrillDesc')?.textContent,
                            homepageVisible: !document.getElementById('homepage')?.classList.contains('hidden'),
                            drillPracticeVisible: !document.getElementById('drillPractice')?.classList.contains('hidden')
                        }
                    };

                    // Format as readable text
                    const text = `DADA Debug Info - ${new Date().toISOString()}
==============================================

USER AGENT:
${navigator.userAgent}

URL: ${window.location.href}

APP STATE:
- API Base URL: ${this.API_BASE_URL}
- User: ${JSON.stringify(this.user, null, 2)}
- Available Drills Count: ${this.availableDrills.length}
- Recommendation: ${JSON.stringify(this.recommendation, null, 2)}
- Current Drill: ${JSON.stringify(this.currentDrill, null, 2)}
- Current Session: ${JSON.stringify(this.currentSession, null, 2)}

UI STATE:
- Homepage Visible: ${!document.getElementById('homepage')?.classList.contains('hidden')}
- Drill Practice Visible: ${!document.getElementById('drillPractice')?.classList.contains('hidden')}
- Recommendation Text: "${document.getElementById('recommendationText')?.textContent}"
- Recommended Drill Name: "${document.getElementById('recommendedDrillName')?.textContent}"

DEBUG LOG (last 50 entries):
${this.debugLog.slice(-50).map(entry =>
    `[${entry.timestamp}] ${entry.message}${entry.data ? '\n  Data: ' + JSON.stringify(entry.data, null, 2) : ''}`
).join('\n\n')}
`;

                    // Copy to clipboard
                    await navigator.clipboard.writeText(text);
                    alert('Debug info copied to clipboard! You can now paste it.');
                } catch (error) {
                    console.error('Failed to copy debug info:', error);
                    alert('Failed to copy debug info. Check console for details.');
                }
            }

            async checkAuth() {
                try {
                    const response = await fetch('https://auth.benloe.com/api/auth/me', {
                        method: 'GET',
                        credentials: 'include',
                        headers: { 'Accept': 'application/json' }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        this.user = data.user;
                    }
                } catch (error) {
                    console.error('Auth failed:', error);
                }
            }

            showMainApp() {
                document.getElementById('authCheck').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                if (this.user) {
                    const greeting = this.user.name || this.user.email || 'Practitioner';
                    document.getElementById('userGreeting').textContent = greeting;
                }
            }

            showNotAuthenticated() {
                document.getElementById('authCheck').classList.add('hidden');
                document.getElementById('notAuthenticated').classList.remove('hidden');
            }

            async startDrill(drillId) {
                try {
                    // Find drill from available drills
                    this.currentDrill = this.availableDrills.find(d => d.id === drillId);
                    if (!this.currentDrill) {
                        console.error('Drill not found:', drillId);
                        return;
                    }

                    // Create session via API
                    const response = await fetch(`${this.API_BASE_URL}/sessions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ drillId })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to create session');
                    }

                    this.currentSession = await response.json();
                    this.drillProgress = [];
                    this.sessionThrows = [];

                    // Show drill practice view
                    this.showDrillPractice();

                    // Update UI
                    document.getElementById('drillName').textContent = this.currentDrill.name;
                    document.getElementById('drillDescription').textContent = this.currentDrill.description;
                    this.updateDrillProgress();
                    this.updateSessionStats();
                    this.updateProfessorComment('start');
                } catch (error) {
                    console.error('Error starting drill:', error);
                    alert('Failed to start drill. Please try again.');
                }
            }

            selectNumber(number) {
                // Remove previous selection
                document.querySelectorAll('.dart-button').forEach(btn => btn.classList.remove('selected'));
                event.target.classList.add('selected');

                this.selectedNumber = number;

                // Show ring type selection if not bull or miss
                if (number === 'bull') {
                    this.selectedRingType = 'double';
                    this.updateSelectedThrow();
                    document.getElementById('ringTypeSection').style.display = 'none';
                } else if (number === 0) {
                    this.selectedRingType = null;
                    this.updateSelectedThrow();
                    document.getElementById('ringTypeSection').style.display = 'none';
                } else {
                    this.selectedRingType = null;
                    document.getElementById('ringTypeSection').style.display = 'block';
                    document.getElementById('selectedThrow').style.display = 'none';
                    document.getElementById('recordButton').disabled = true;
                }
            }

            selectRingType(ringType) {
                // Remove previous selection
                document.querySelectorAll('#ringTypeSection .dart-button').forEach(btn => btn.classList.remove('selected'));
                event.target.classList.add('selected');

                this.selectedRingType = ringType;
                this.updateSelectedThrow();
            }

            updateSelectedThrow() {
                if (this.selectedNumber === null) return;

                let throwText = '';
                let score = 0;

                if (this.selectedNumber === 0) {
                    throwText = 'Miss';
                    score = 0;
                } else if (this.selectedNumber === 'bull') {
                    throwText = 'Double Bull';
                    score = 50;
                } else if (this.selectedRingType) {
                    const multiplier = this.selectedRingType === 'treble' ? 3 :
                                     this.selectedRingType === 'double' ? 2 : 1;
                    const prefix = this.selectedRingType === 'single' ? '' :
                                  this.selectedRingType.charAt(0).toUpperCase() + this.selectedRingType.slice(1) + ' ';
                    throwText = `${prefix}${this.selectedNumber}`;
                    score = this.selectedNumber * multiplier;
                } else {
                    return;
                }

                document.getElementById('selectedThrowText').textContent = throwText;
                document.getElementById('selectedThrowScore').textContent = score + ' points';
                document.getElementById('selectedThrow').style.display = 'block';
                document.getElementById('recordButton').disabled = false;
            }

            async recordThrow() {
                if (this.selectedNumber === null || !this.currentSession) return;

                const throwData = {
                    number: String(this.selectedNumber),
                    ringType: this.selectedRingType,
                    score: this.calculateScore()
                };

                try {
                    // Send throw to API
                    const response = await fetch(`${this.API_BASE_URL}/sessions/${this.currentSession.id}/throws`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(throwData)
                    });

                    if (!response.ok) {
                        throw new Error('Failed to record throw');
                    }

                    const result = await response.json();

                    // Update local state
                    throwData.timestamp = new Date().toISOString();
                    this.drillProgress.push(throwData);
                    this.sessionThrows.push(throwData);

                    this.updateUI();
                    this.resetInput();

                    // Check if drill is complete
                    if (this.drillProgress.length >= this.currentDrill.throw_count) {
                        await this.completeDrill();
                    }
                } catch (error) {
                    console.error('Error recording throw:', error);
                    alert('Failed to record throw. Please try again.');
                }
            }

            calculateScore() {
                if (this.selectedNumber === 0) return 0;
                if (this.selectedNumber === 'bull') return 50;

                const multiplier = this.selectedRingType === 'treble' ? 3 :
                                 this.selectedRingType === 'double' ? 2 : 1;
                return this.selectedNumber * multiplier;
            }

            resetInput() {
                this.selectedNumber = null;
                this.selectedRingType = null;
                document.querySelectorAll('.dart-button').forEach(btn => btn.classList.remove('selected'));
                document.getElementById('ringTypeSection').style.display = 'none';
                document.getElementById('selectedThrow').style.display = 'none';
                document.getElementById('recordButton').disabled = true;
            }

            updateUI() {
                this.updateDrillProgress();
                this.updateSessionStats();
                this.updateRecentThrows();
                this.updateProfessorComment('throw');
            }

            updateDrillProgress() {
                const progress = this.drillProgress.length;
                const total = this.currentDrill.throw_count;
                const percentage = (progress / total) * 100;

                document.getElementById('drillProgress').textContent = `${progress} / ${total} throws`;
                document.getElementById('progressBar').style.width = percentage + '%';
            }

            updateSessionStats() {
                const totalThrows = this.sessionThrows.length;
                document.getElementById('sessionThrows').textContent = totalThrows;

                // Calculate accuracy based on current drill target
                if (this.currentDrill.target_number && this.currentDrill.target_ring) {
                    const hits = this.drillProgress.filter(t =>
                        String(t.number) === String(this.currentDrill.target_number) &&
                        t.ringType === this.currentDrill.target_ring
                    ).length;
                    const accuracy = this.drillProgress.length > 0 ?
                        Math.round((hits / this.drillProgress.length) * 100) : 0;
                    document.getElementById('sessionAccuracy').textContent = accuracy + '%';
                } else {
                    // No target (e.g., High Score Hunt)
                    document.getElementById('sessionAccuracy').textContent = 'N/A';
                }

                // Calculate 3-dart average
                const totalScore = this.sessionThrows.reduce((sum, t) => sum + t.score, 0);
                const threeDartAvg = totalThrows > 0 ? (totalScore / totalThrows * 3).toFixed(1) : '0.0';
                document.getElementById('session3DA').textContent = threeDartAvg;
            }

            updateRecentThrows() {
                const container = document.getElementById('recentThrows');
                const recent = this.sessionThrows.slice(-5).reverse();

                if (recent.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-xs text-center py-4">No throws yet</p>';
                    return;
                }

                container.innerHTML = recent.map(t => {
                    let displayName = '';
                    if (t.number === 0) displayName = 'Miss';
                    else if (t.number === 'bull') displayName = 'Double Bull';
                    else {
                        const prefix = t.ringType === 'single' ? '' :
                                      t.ringType.charAt(0).toUpperCase() + t.ringType.slice(1) + ' ';
                        displayName = `${prefix}${t.number}`;
                    }

                    const isTarget = this.currentDrill.target_number && this.currentDrill.target_ring &&
                                   String(t.number) === String(this.currentDrill.target_number) &&
                                   t.ringType === this.currentDrill.target_ring;

                    return `
                        <div class="flex justify-between items-center p-2 rounded text-sm ${isTarget ? 'bg-green-50' : 'bg-gray-50'}">
                            <div>
                                <span class="font-semibold">${displayName}</span>
                                ${isTarget ? '<span class="ml-2 text-green-600 text-xs">‚úì Hit</span>' : ''}
                            </div>
                            <div class="font-bold ${isTarget ? 'text-green-600' : 'text-gray-700'}">${t.score}</div>
                        </div>
                    `;
                }).join('');
            }

            updateProfessorComment(context) {
                const comments = {
                    start: [
                        `"Your drill today: focus on ${this.currentDrill.name}. Show me you can hit it with consistency. Begin."`,
                        `"We shall practice ${this.currentDrill.name}. Constant vigilance is required."`,
                        `"Today's lesson: ${this.currentDrill.name}. Do not disappoint me."`
                    ],
                    hit: [
                        '"Acceptable. Do not let success inflate your ego."',
                        '"Your aim improves. Marginally."',
                        '"Adequate. Barely."',
                        '"Consistency requires constant vigilance."'
                    ],
                    miss: [
                        '"Disappointing. Focus on fundamentals."',
                        '"Your form is as scattered as your throws."',
                        '"Dreadful. We shall revisit this."',
                        '"Concentration. You lack it."'
                    ],
                    complete: [
                        '"Session complete. Your performance was... sufficient."',
                        '"Finished. Review your results and return when ready."',
                        '"Done. Progress is measured in consistency, not single sessions."'
                    ]
                };

                let comment;
                if (context === 'start') {
                    comment = comments.start[Math.floor(Math.random() * comments.start.length)];
                } else if (context === 'complete') {
                    comment = comments.complete[Math.floor(Math.random() * comments.complete.length)];
                } else {
                    const lastThrow = this.drillProgress[this.drillProgress.length - 1];
                    const isHit = this.currentDrill.target_number && this.currentDrill.target_ring &&
                                String(lastThrow.number) === String(this.currentDrill.target_number) &&
                                lastThrow.ringType === this.currentDrill.target_ring;

                    const commentList = isHit ? comments.hit : comments.miss;
                    comment = commentList[Math.floor(Math.random() * commentList.length)];
                }

                document.getElementById('professorComment').textContent = comment;
            }

            async completeDrill() {
                this.updateProfessorComment('complete');

                try {
                    // Complete session via API
                    const response = await fetch(`${this.API_BASE_URL}/sessions/${this.currentSession.id}/complete`, {
                        method: 'PATCH',
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        throw new Error('Failed to complete session');
                    }

                    const completedSession = await response.json();

                    // Calculate drill stats for display
                    const hits = this.currentDrill.target_number && this.currentDrill.target_ring ?
                        this.drillProgress.filter(t =>
                            String(t.number) === String(this.currentDrill.target_number) &&
                            t.ringType === this.currentDrill.target_ring
                        ).length : 0;

                    const accuracy = this.currentDrill.target_number && this.currentDrill.target_ring ?
                        Math.round((hits / this.drillProgress.length) * 100) : 0;

                    console.log('Drill completed:', {
                        drill: this.currentDrill.id,
                        accuracy,
                        sessionId: this.currentSession.id
                    });

                    // Return to homepage after short delay
                    setTimeout(async () => {
                        await this.loadRecommendation();
                        this.showHomepage();
                    }, 2000);
                } catch (error) {
                    console.error('Error completing drill:', error);
                    alert('Failed to complete drill. Your data has been saved, but there was an error finalizing the session.');
                }
            }
        }

        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new DADAApp();
        });
    </script>
</body>
</html>
